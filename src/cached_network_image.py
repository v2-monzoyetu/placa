import flet as ft
import requests
from pathlib import Path
import hashlib
import base64
from io import BytesIO
from PIL import Image

CACHE_DIR = Path("cache")
CACHE_DIR.mkdir(exist_ok=True)

DEFAULT_IMAGE_BASE64 = (
    "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"
)

def get_cache_path(url):
    url_hash = hashlib.md5(url.encode()).hexdigest()
    suffix = Path(url).suffix or ".jpg"
    return CACHE_DIR / f"{url_hash}{suffix}"

def download_image(url, cache_path):
    try:
        response = requests.get(url, timeout=10)
        if response.status_code == 200 and "image" in response.headers.get("Content-Type", "").lower():
            try:
                img = Image.open(BytesIO(response.content))
                img.verify()
            except Exception:
                return False
            with open(cache_path, "wb") as f:
                f.write(response.content)
            return True
        return False
    except Exception:
        return False

def get_image_path(url):
    try:
        cache_path = get_cache_path(url)
        if cache_path.exists():
            return cache_path
        if download_image(url, cache_path):
            return cache_path
        return None
    except Exception:
        return None

def load_image_to_base64(image_path):
    try:
        if not image_path or not Path(image_path).exists():
            return DEFAULT_IMAGE_BASE64
        with Image.open(image_path) as img:
            buffered = BytesIO()
            img_format = img.format or "JPEG"
            img.save(buffered, format=img_format)
            return base64.b64encode(buffered.getvalue()).decode("utf-8")
    except Exception:
        return DEFAULT_IMAGE_BASE64

def cached_network_image(page: ft.Page, link: str):
    image_control = ft.Image(
        src_base64=DEFAULT_IMAGE_BASE64,
        width=250,
        height=250,
        fit=ft.ImageFit.COVER,
        border_radius=ft.border_radius.all(250),
    )

    loading_indicator = ft.ProgressRing(width=50, height=50, visible=True)

    stack = ft.Stack(
        controls=[
            image_control,
            ft.Container(content=loading_indicator, alignment=ft.alignment.center),
        ]
    )

    container = ft.Container(
        content=stack,
        width=260,
        height=260,
        border=ft.border.all(5, ft.Colors.WHITE),
        border_radius=ft.border_radius.all(260),
        padding=5,
        alignment=ft.alignment.center,
    )
    
    try:
        cache_path = get_image_path(link)
        image_base64 = load_image_to_base64(cache_path)

        image_control.src_base64 = image_base64 or DEFAULT_IMAGE_BASE64

    except Exception as e:
        print(f"❌ Erro no cached_network_image: {e}")
        image_control.src_base64 = DEFAULT_IMAGE_BASE64

    loading_indicator.visible = False
    page.update()

    return container
